// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_jsmMcHkAtD76@ep-tiny-feather-adnrzgye-pooler.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
}

model User {
  id                 Int        @id @default(autoincrement())
  name               String
  email              String     @unique
  password           String
  roleId             Int
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  // Relationship Fields
  role               Role       @relation(fields: [roleId], references: [id])
  // Relationship Tables
  vendorUserCreate   Vendor[]   @relation("vendorUserCreate")
  vendorUserUpdate   Vendor[]   @relation("vendorUserUpdate")
  customerUserCreate Customer[] @relation("customerUserCreate")
  customerUserUpdate Customer[] @relation("customerUserUpdate")
}

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique // "Admin", "Sales", "Inventory", "Accounts"
  permissions Permission[]
  users       User[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Permission {
  id        Int      @id @default(autoincrement())
  action    String // "create", "read", "update", "delete"
  subject   String // "SaleOrder", "PurchaseOrder", etc.
  roleId    Int
  role      Role     @relation(fields: [roleId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model businessCategory {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  customers Customer[] @relation("customerCategory")
}

model Customer {
  id                  Int               @id @default(autoincrement())
  code                String            @unique // e.g., "CUST-001"
  name                String
  shopname            String?
  phone               String?
  email               String
  address             String?
  city                String?
  state               String?
  pincode             String?
  businessCategory_id Int?
  gstin               String?
  credit_limit        Int?
  outstanding_credit  Int?
  notes               String?
  // Default fields
  active_status       Boolean           @default(true)
  delete_status       Boolean           @default(false)
  createdAt           DateTime          @default(now())
  createdBy           Int
  updatedAt           DateTime          @updatedAt
  updatedBy           Int?
  // Relationship Fields
  categoryRel         businessCategory? @relation("customerCategory", fields: [businessCategory_id], references: [id])
  usercreate          User              @relation("customerUserCreate", fields: [createdBy], references: [id])
  userupdate          User?             @relation("customerUserUpdate", fields: [updatedBy], references: [id])
  // Relationship Tables
  saleOrders          SaleOrder[]
  dispatchCopies      DispatchCopy[]
}

model Vendor {
  id             Int             @id @default(autoincrement())
  code           String          @unique // e.g., "VEND-001"
  name           String
  shopname       String?
  phone          String?
  email          String
  address        String?
  city           String?
  state          String?
  pincode        String?
  category       String?
  gstin          String?
  // Default fields
  active_status  Boolean         @default(true)
  delete_status  Boolean         @default(false)
  notes          String?
  createdAt      DateTime        @default(now())
  createdBy      Int
  updatedAt      DateTime        @updatedAt
  updatedBy      Int
  // Relationship Fields
  usercreate     User            @relation("vendorUserCreate", fields: [createdBy], references: [id])
  userupdate     User            @relation("vendorUserUpdate", fields: [updatedBy], references: [id])
  // Relationship Tables
  purchaseOrders PurchaseOrder[]
}

model LensType {
  id          Int           @id @default(autoincrement())
  name        String        @unique // e.g., "Single Vision", "Progressive"
  description String?
  variants    LensVariant[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model LensVariant {
  id          Int             @id @default(autoincrement())
  name        String // e.g., "Acuvue Oasys"
  description String?
  lensType    LensType        @relation(fields: [lensTypeId], references: [id])
  lensTypeId  Int
  price       Float
  isRx        Boolean         @default(false) // true = requires PO
  stock       Int             @default(0) // for in-stock items
  minStock    Int             @default(5) // minimum stock threshold
  saleOrders  SaleOrderItem[]
  poItems     POItem[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([lensTypeId])
}

// Forward declarations for related models
enum SaleOrderStatus {
  DRAFT
  CONFIRMED
  IN_PRODUCTION
  READY_FOR_DISPATCH
  DELIVERED
}

model SaleOrder {
  id               Int             @id @default(autoincrement())
  customerId       Int
  customer         Customer        @relation(fields: [customerId], references: [id])
  status           SaleOrderStatus @default(DRAFT)
  // Basic order information
  customerRefNo    String? // Customer reference number
  orderDate        DateTime        @default(now())
  type             String? // "Normal Processing", "Rush Processing", "Premium Processing"
  deliverySchedule DateTime?
  remark           String?
  itemRefNo        String?
  freeLens         Boolean         @default(false)
  // Lens details
  lensName         String?
  category         String? // "Single Vision", "BiFocal", "Progressive", "Reading"
  lensType         String? // "Glass", "Plastic", "Polycarbonate", "Trivex"
  dia              String?
  fittingType      String? // "Standard", "Premium", "Custom"
  coatingType      String? // "Anti-Reflection", "UV Protection", "Blue Light", "Scratch Resistant"
  coatingName      String? // "CLAIRITE", "CRIZAL", "ULTRA", "PREMIUM"
  tintingName      String? // "Clear", "Light Brown", "Dark Brown", "Gray", "Green"
  // Eye selection
  rightEye         Boolean         @default(false)
  leftEye          Boolean         @default(false)
  // Right eye specifications
  rightSpherical   String?
  rightCylindrical String?
  rightAxis        String?
  rightAdd         String?
  rightDia         String?
  rightBase        String?
  rightBaseSize    String?
  rightBled        String?
  // Left eye specifications
  leftSpherical    String?
  leftCylindrical  String?
  leftAxis         String?
  leftAdd          String?
  leftDia          String?
  leftBase         String?
  leftBaseSize     String?
  leftBled         String?
  // Dispatch information
  dispatchStatus   String?         @default("Pending") // "Pending", "Assigned", "In Transit", "Delivered"
  assignedPerson   String?
  dispatchId       String?
  estimatedDate    DateTime?
  estimatedTime    String?
  actualDate       DateTime?
  actualTime       String?
  dispatchNotes    String?
  // Billing information
  lensPrice        Float           @default(0)
  coatingPrice     Float           @default(0)
  fittingPrice     Float           @default(0)
  tintingPrice     Float           @default(0)
  discount         Float           @default(0) // Percentage discount
  // Relations
  items            SaleOrderItem[]
  invoice          Invoice?        @relation(fields: [invoiceId], references: [id])
  invoiceId        Int?
  purchaseOrders   PurchaseOrder[]
  dispatch         DispatchCopy?   @relation(fields: [dispatchCopyId], references: [id])
  dispatchCopyId   Int?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([invoiceId])
  @@index([dispatchCopyId])
}

model SaleOrderItem {
  id            Int         @id @default(autoincrement())
  saleOrderId   Int
  saleOrder     SaleOrder   @relation(fields: [saleOrderId], references: [id])
  lensVariantId Int
  lensVariant   LensVariant @relation(fields: [lensVariantId], references: [id])
  quantity      Int         @default(1)
  price         Float // Price at time of sale
  discount      Float       @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([saleOrderId])
  @@index([lensVariantId])
}

enum PaymentMethod {
  CASH
  UPI
  CARD
  BANK_TRANSFER
  CHECK
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIALLY_PAID
  PAID
  CANCELLED
}

model Invoice {
  id          Int           @id @default(autoincrement())
  invoiceNo   String        @unique // e.g., INV-2025-001
  status      InvoiceStatus @default(DRAFT)
  saleOrders  SaleOrder[]
  totalAmount Float
  paidAmount  Float         @default(0)
  dueDate     DateTime
  payments    Payment[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Payment {
  id          Int           @id @default(autoincrement())
  invoiceId   Int
  invoice     Invoice       @relation(fields: [invoiceId], references: [id])
  amount      Float
  method      PaymentMethod
  referenceNo String? // For UPI/Card/Bank transactions
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([invoiceId])
}

enum POStatus {
  PENDING
  ORDERED
  RECEIVED
  CANCELLED
}

model PurchaseOrder {
  id          Int        @id @default(autoincrement())
  poNumber    String     @unique // e.g., PO-2025-001
  vendorId    Int
  vendor      Vendor     @relation(fields: [vendorId], references: [id])
  status      POStatus   @default(PENDING)
  totalValue  Float
  notes       String?
  items       POItem[]
  saleOrderId Int?
  saleOrder   SaleOrder? @relation(fields: [saleOrderId], references: [id])
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([vendorId])
  @@index([saleOrderId])
}

enum DispatchStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
}

model DispatchCopy {
  id            Int            @id @default(autoincrement())
  dcNumber      String         @unique // e.g., DC-2025-001
  customerId    Int
  customer      Customer       @relation(fields: [customerId], references: [id])
  status        DispatchStatus @default(PENDING)
  notes         String?
  vehicleNumber String?
  driverName    String?
  driverContact String?
  deliveryNotes String?
  saleOrders    SaleOrder[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([customerId])
}

model POItem {
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  lensVariantId   Int
  lensVariant     LensVariant   @relation(fields: [lensVariantId], references: [id])
  quantity        Int
  price           Float // Purchase price
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([purchaseOrderId])
  @@index([lensVariantId])
}
